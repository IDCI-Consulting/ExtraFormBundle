var fixture5Raw = "{\n    \"name\": \"ferrero_participation\",\n    \"steps\": {\n        \"editor\": {\n            \"type\": \"form\",\n            \"options\": {\n                \"nav_title\": \"Je personnalise mon mug Nutella\",\n                \"title\": \"Personnalisez votre Mug Nutella avec <br /> la photo et le prénom ou le message de votre choix\",\n                \"display_title\": false,\n                \"attr\": {\n                    \"class\": \"mug_editor\"\n                },\n                \"js\": \"$('.mug_editor').on('submit', function(event) {    var $img = $('img.cropper-hidden');    if ($img.length && ($img[0].width < 258 && $img[0].height < 193)) {        event.preventDefault();        event.stopPropagation();        var $modal = $('<div class=\\\"reveal-modal\\\" data-reveal role=\\\"dialog\\\"><div class=\\\"modal-box\\\"><div class=\\\"content\\\">Votre image est de faible résolution (<258 x 193 pixels). Voulez vous continuer ?</div><div class=\\\"actions\\\"></div></div></div>');        var $noButton = $('<a href=\\\"#\\\" class=\\\"button\\\">Non</a>');        var $yesButton = $('<a href=\\\"#\\\" class=\\\"button\\\">Oui</a>');        $noButton.on('click', function (e) {            $modal.foundation('reveal', 'close');        });        $yesButton.on('click', function (e) {            $('.mug_editor').unbind('submit');            $('.mug_editor .next').trigger('click');            $('body').addClass('loading');            $modal.foundation('reveal', 'close');        });        $modal.find('.actions').append($noButton);        $modal.find('.actions').append($yesButton);        $modal.foundation('reveal', 'open');    } else {        $('body').addClass('loading');    };}); $('ul.errors + input').one('focus', function() { $(this).prev().remove(); }); $('input.firstname').on('keyup', function() { $(this).attr('value', $(this).val()); }); var updateEditorButtons = function() { var $resetButton = $('.edition_area input.reset'); if (! $resetButton.length) { setTimeout(function() { updateEditorButtons(); }, 1); return; } $('form .actions').prepend($resetButton); $resetButton.hide(); var $inputFile = $('.edition_area input[type=file]'); $inputFile.css({ cursor: 'pointer', display: 'block', fontSize: '1000px', width: '100%' }); var $inputContainer = $('<span>'); $inputContainer.css({ cursor: 'pointer', filter: 'alpha(opacity=0)', height: '100%', left: 0, opacity: 0, overflow: 'hidden', position: 'absolute', top: 0, width: '100%', zIndex: 1 }); $inputContainer.append($inputFile); var $imgContainer = $('.edition_area .image_container'); $imgContainer.append($inputContainer); $imgContainer.find('img').one('load', function() { $(this).parents('form').addClass('nologo'); $resetButton.show(); var $updateButtonContainer = $('<div>'); $updateButtonContainer.css({ display: 'inline-block', position: 'relative' }); $updateButtonContainer.append($inputContainer); $updateButtonContainer.append('<a href=\\\"#\\\" class=\\\"button change\\\" style=\\\"margin:0 1px\\\">Télécharger une nouvelle image</a>'); var $editorArea = $('.edition_area .rotate').parent(); $editorArea.append($updateButtonContainer); }); }; updateEditorButtons();\",\n                \"@builder\": {\n                    \"worker\": \"extra_form_builder\",\n                    \"parameters\": {\n                        \"configuration\": {\n                            \"media_uploaded-1\": {\n                                \"extra_form_type\": \"tms_transformable_image_upload\",\n                                \"options\": {\n                                    \"help\": \"<p class='format-file size-format'>Formats acceptés : jpeg, png<br/>Poids maximum : 5Mo<br/>La saisie du texte est limitée à 14 caractères maximum.</p>\",\n                                    \"container_width\": 268,\n                                    \"container_height\": 201,\n                                    \"label\": \"Ajustez votre image\",\n                                    \"required\": true,\n                                    \"attr\": {\n                                        \"class\": \"edition_area split_line\"\n                                    },\n                                    \"metadata\": {\n                                        \"customer\": \"{{ participation.offer.customer.reference }}\",\n                                        \"offer\": \"{{ participation.offer.reference }}\"\n                                    },\n                                    \"rotate_attr\": {\"class\": \"rotate\"},\n                                    \"zoom_attr\": {\"class\": \"zoom\"},\n                                    \"reset_attr\": {\"class\": \"reset\", \"value\": \"Réinitialiser\"}\n                                },\n                                \"constraints\": [\n                                    {\n                                        \"extra_form_constraint\": \"tms_media_upload_not_blank\",\n                                        \"options\": {\n                                            \"message\": \"Merci de télécharger une image ou photo pour personnaliser votre mug.\"\n                                        }\n                                    },\n                                    {\n                                        \"extra_form_constraint\": \"tms_media_upload_file\",\n                                        \"options\": {\n                                            \"maxSize\": \"5M\",\n                                            \"maxSizeMessage\": \"Poids incorrect : Le poids de votre image dépasse la limite autorisée de 5Mo. Merci de réduire son poids et recommencer.\",\n                                            \"uploadIniSizeErrorMessage\": \"Poids incorrect : Le poids de votre image dépasse la limite autorisée de 5Mo. Merci de réduire son poids et recommencer.\",\n                                            \"uploadFormSizeErrorMessage\": \"Poids incorrect : Le poids de votre image dépasse la limite autorisée de 5Mo. Merci de réduire son poids et recommencer.\",\n                                            \"mimeTypes\": [\n                                                \"image/png\",\n                                                \"image/jpeg\"\n                                            ],\n                                            \"mimeTypesMessage\": \"Format non reconnu : Le format de votre fichier est incorrect. Merci de bien vérifier la liste des formats acceptés.\"\n                                        }\n                                    }\n                                ]\n                            },\n                            \"miscellaneous_textField\": {\n                                \"extra_form_type\": \"text\",\n                                \"options\": {\n                                    \"error_bubbling\": \"true\",\n                                    \"max_length\": 14,\n                                    \"required\": false,\n                                    \"attr\": {\n                                        \"class\": \"firstname\"\n                                    }\n                                },\n                                \"constraints\": [\n                                    {\n                                        \"extra_form_constraint\": \"regex\",\n                                        \"options\": {\n                                            \"message\": \"Vous ne pouvez pas saisir les caractères suivants: '<', '&' et '%'\",\n                                            \"pattern\": \"#^[^&<%]+$#\"\n                                        }\n                                    }\n                                ]\n                            }\n                        }\n                    }\n                },\n                \"events\": {\n                    \"form.post_set_data\": [\n                        {\n                            \"action\": \"conditional_stop_navigation\",\n                            \"name\": \"is_max_order\",\n                            \"parameters\": {\n                                \"final_destination\": \"/\",\n                                \"rules\": {\n                                    \"order_limit\": {\n                                        \"limit\": 3,\n                                        \"query\": {\n                                            \"customer\": \"{{ participation.offer.customer.reference }}\",\n                                            \"participation\": \"{{ '{{ flow_data.retrievedData.identity.created_participation.id|default(\\'\\') }}' }}\"\n                                        }\n                                    }\n                                }\n                            }\n                        },\n                        {\n                            \"action\": \"notify\",\n                            \"parameters\": {\n                                \"type\": \"modal\",\n                                \"logical_expression\": \"{{ '{{ flow_data.retrievedData.editor.is_max_order }}' }}\",\n                                \"options\": {\n                                    \"level\": \"warning\",\n                                    \"message\": \"Vous avez atteint le nombre limite de modifications de votre demande.\"\n                                }\n                            }\n                        },\n                        {\n                            \"action\": \"conditional_stop_navigation\",\n                            \"name\": \"is_outdated_participation\",\n                            \"parameters\": {\n                                \"final_destination\": \"/\",\n                                \"rules\": {\n                                    \"participation_limit\": {\n                                        \"limit\": 1,\n                                        \"query\": {\n                                            \"customer\": \"{{ participation.offer.customer.reference }}\",\n                                            \"id\": \"{{ '{{ flow_data.retrievedData.identity.created_participation.id|default(\\'\\') }}' }}\",\n                                            \"updated_at\": \"<~~{{ '-3 days'|date('Y-m-d') }}T00:00:00CET\"\n                                        }\n                                    }\n                                }\n                            }\n                        },\n                        {\n                            \"action\": \"notify\",\n                            \"parameters\": {\n                                \"type\": \"modal\",\n                                \"logical_expression\": \"{{ '{{ flow_data.retrievedData.editor.is_outdated_participation }}' }}\",\n                                \"options\": {\n                                    \"level\": \"warning\",\n                                    \"message\": \"Vous avez dépassé le délai autorisé pour modifier votre demande.\"\n                                }\n                            }\n                        }\n                    ]\n                }\n            }\n        },\n        \"preview\": {\n            \"type\": \"html\",\n            \"options\": {\n                \"title\": \"Prévisualisez votre mug\",\n                \"previous_options\": {\"label\": \"Précédent\"},\n                \"attr\": {\n                    \"class\": \"preview_mug\"\n                },\n                \"js\": \"$('form.preview_mug').on('submit', function(){ $('body').addClass('loading'); });\",\n                \"events\": {\n                    \"form.post_set_data\": [\n                        {\n                            \"action\": \"change_data\",\n                            \"parameters\": {\n                                \"fields\": {\n                                    \"content\": \"<img src=\\\"data: {{ '{{ flow_data.retrievedData.editor.preview.mime_type | default() }}' }};base64,{{ '{{ flow_data.retrievedData.editor.preview.base64 | default() }}' }}\\\" alt=\\\"preview\\\" />{{ '{% if flow_data.retrievedData.editor.cropped_image.width < 1072 or flow_data.retrievedData.editor.cropped_image.height < 804 %}<div class=\\\\\\\"callout warning\\\\\\\">Attention, votre image ne couvre pas l\\'intégralité de l\\'espace qui lui est réservé. Voulez-vous continuer ?</div>{% endif %}' }}\"\n                                }\n                            }\n                        }\n                    ]\n                }\n            }\n        },\n        \"proof\": {\n            \"type\": \"form\",\n            \"options\": {\n                \"title\": \"CONFIRMEZ VOTRE ACHAT\",\n                \"previous_options\": {\"label\": \"Précédent\"},\n                \"display_title\": false,\n                \"attr\": {\n                    \"class\": \"confirm_purchase\"\n                },\n                \"js\": \"$('.confirm_purchase button[type=submit]').on('click', function(event) {    $(this).attr('clicked', 'true');    });    $('.confirm_purchase').on('submit', function(event) {    if ($(this).find('.next').attr('clicked') == 'true') {    event.preventDefault();    event.stopPropagation();    var $modal = $('<div class=\\\"reveal-modal\\\" style=\\\"bottom: 0;top: initial!important;height: auto!important;\\\" data-reveal role=\\\"dialog\\\"><div class=\\\"modal-box\\\"><div class=\\\"content\\\">Merci de bien vouloir vérifier que votre sticker soit bien visible sur la photo du pot Nutella, que votre ticket de caisse soit lisible et qu’il présente toutes les informations nécessaires au traitement de votre participation.</div><div class=\\\"actions\\\"></div></div></div>');    var $okButton = $('<a href=\\\"#\\\" class=\\\"button\\\">Ok</a>');    $okButton.on('click', function (e) {    $('.confirm_purchase').unbind('submit').on('submit', function(){        $('body').addClass('loading');    });    $modal.foundation('reveal', 'close');$(document).on('closed.fndtn.reveal', '[data-reveal]', function () { $('.actions button.next').blur().focus();});     });    $modal.find('.actions').append($okButton);    $modal.foundation('reveal', 'open');    }    });    $('ul.errors + input').one('focus', function(){    $(this).prev().remove();    });\",\n                \"@builder\": {\n                    \"worker\": \"extra_form_builder\",\n                    \"parameters\": {\n                        \"configuration\": {\n                            \"purchase-1_product-1\": {\n                                \"extra_form_type\": \"tms_gtin\",\n                                \"options\": {\n                                    \"label\": \"<strong>RENSEIGNEZ LE CODE-BARRES DE VOTRE POT COLLECTOR NUTELLA 1KG</strong> <br> <small>Valable sur les pots de Nutella 1kg porteurs de l'offre</small>\",\n                                    \"attr\": {\n                                        \"maxlength\": 13,\n                                        \"class\": \"tms_purchase\"\n                                    },\n                                    \"gtin_name\": \"EAN\",\n                                    \"api_request_url\": \"https://ferrero.odr.fr/api/products\",\n                                    \"api_collection_path\": \"data\",\n                                    \"api_element_attribute_path\": \"name\",\n                                    \"invalid_message\": \"\",\n                                    \"unknown_message\": \"\",\n                                    \"error_message\": \"Une erreur est survenue\",\n                                    \"searching_message\": \"Recherche le produit ...\"\n                                },\n                                \"constraints\": [\n                                    {\n                                        \"extra_form_constraint\": \"not_blank\",\n                                        \"options\": {\n                                            \"message\": \"Vous devez saisir un code-barres\"\n                                        }\n                                    },\n                                    {\n                                        \"extra_form_constraint\": \"tms_gtin_product\",\n                                        \"options\": {\n                                            \"message\": \"Produit non reconnu\",\n                                            \"gtinName\": \"EAN\",\n                                            \"customerId\": \"{{ participation.offer.customer.id }}\",\n                                            \"offerId\": \"{{ participation.offer.id }}\"\n                                        }\n                                    }\n                                ]\n                            },\n                            \"help\": {\n                                \"extra_form_type\": \"html\",\n                                \"options\": {\n                                    \"content\": \"<p><strong>Téléchargez votre ticket de caisse</strong></p><p>Veuillez télécharger la preuve d'achat dans son intégralité en veillant à ce que les éléments suivants soient bien lisibles : </p><ul class = 'help-list'><li>Le nom de votre point de vente</li><li>La date et l'heure de votre achat</li><li>Le nom du produit acheté ainsi que le montant (TTC)</li><li>Le montant total (TTC) de votre preuve d'achat</li></ul>\",\n                                    \"attr\": {\n                                        \"class\": \"help\"\n                                    }\n                                }\n                            },\n                            \"purchase-1_proof-1\": {\n                                \"extra_form_type\": \"tms_media_upload\",\n                                \"options\": {\n                                    \"label\": \" \",\n                                    \"required\": true,\n                                    \"metadata\": {\n                                        \"customer\": \"{{ participation.offer.customer.reference }}\",\n                                        \"offer\": \"{{ participation.offer.reference }}\"\n                                    },\n                                    \"attr\": {\n                                        \"class\": \"proof center\",\n                                        \"placeholder\": \"Parcourir\"\n                                    }\n                                },\n                                \"constraints\": [\n                                    {\n                                        \"extra_form_constraint\": \"tms_media_upload_not_blank\",\n                                        \"options\": {\n                                            \"message\": \"Merci de télécharger une photo de votre ticket de caisse.\"\n                                        }\n                                    },\n                                    {\n                                        \"extra_form_constraint\": \"tms_media_upload_file\",\n                                        \"options\": {\n                                            \"maxSize\": \"3M\",\n                                            \"maxSizeMessage\": \"Poids incorrect : Le poids de votre fichier dépasse la limite autorisée de 3Mo. Merci de réduire son poids et recommencer.\",\n                                            \"uploadIniSizeErrorMessage\": \"Poids incorrect : Le poids de votre fichier dépasse la limite autorisée de 3Mo. Merci de réduire son poids et recommencer.\",\n                                            \"uploadFormSizeErrorMessage\": \"Poids incorrect : Le poids de votre fichier dépasse la limite autorisée de 3Mo. Merci de réduire son poids et recommencer.\",\n                                            \"mimeTypes\": [\n                                                \"image/png\",\n                                                \"image/jpeg\",\n                                                \"image/gif\",\n                                                \"image/tiff\",\n                                                \"application/pdf\"\n                                            ],\n                                            \"mimeTypesMessage\": \"Format non reconnu : Le format de votre fichier est incorrect. Merci de bien vérifier la liste des formats acceptés.\"\n                                        }\n                                    }\n                                ]\n                            },\n                            \"formats\": {\n                                \"extra_form_type\": \"html\",\n                                \"options\": {\n                                    \"content\": \"<p class='confirm-achat'>Important : Si votre ticket de caisse est trop long, pliez-le en accordéon de façon à faire apparaître le haut et le bas du ticket, et vos achats. <br> Formats acceptés : jpeg, png, gif, pdf, tiff<br> Poids maximum : 3Mo</p>\",\n                                    \"attr\": {\n                                        \"class\": \"formats center\"\n                                    }\n                                }\n                            },\n                            \"notice\": {\n                                \"extra_form_type\": \"html\",\n                                \"options\": {\n                                    \"content\": \"<p class='content_upload'><strong>Téléchargez la photo de votre pot de nutella</strong></p><p>Veuillez télécharger la photo du pot collector Nutella porteur de l'offre, en veillant à ce que le sticker de l'opération soit bien visible.</p><img src=\\\"https://media-manager.digifid.fr/api/media/1379437328-1462283783-e4a46decc2edb1934a21d893adc613a6-530\\\" alt=\\\"Pot collector\\\" title=\\\"Pot collector\\\" style=\\\"position:absolute;right:0;top:0;max-width:190px;max-height: 125px;\\\"/>\",\n                                    \"attr\": {\n                                        \"style\": \"max-width: 750px;padding-right: 200px;position: relative;\"\n                                    }\n                                }\n                            },\n                            \"purchase-1_proof-2\": {\n                                \"extra_form_type\": \"tms_media_upload\",\n                                \"options\": {\n                                    \"label\": \" \",\n                                    \"required\": true,\n                                    \"metadata\": {\n                                        \"customer\": \"{{ participation.offer.customer.reference }}\",\n                                        \"offer\": \"{{ participation.offer.reference }}\"\n                                    },\n                                    \"attr\": {\n                                        \"class\": \"proof center\",\n                                        \"placeholder\": \"Parcourir\"\n                                    }\n                                },\n                                \"constraints\": [\n                                    {\n                                        \"extra_form_constraint\": \"tms_media_upload_not_blank\",\n                                        \"options\": {\n                                            \"message\": \"Merci de télécharger une photo de votre pot de nutella.\"\n                                        }\n                                    },\n                                    {\n                                        \"extra_form_constraint\": \"tms_media_upload_file\",\n                                        \"options\": {\n                                            \"maxSize\": \"3M\",\n                                            \"maxSizeMessage\": \"Poids incorrect : Le poids de votre fichier dépasse la limite autorisée de 3Mo. Merci de réduire son poids et recommencer.\",\n                                            \"uploadIniSizeErrorMessage\": \"Poids incorrect : Le poids de votre fichier dépasse la limite autorisée de 3Mo. Merci de réduire son poids et recommencer.\",\n                                            \"uploadFormSizeErrorMessage\": \"Poids incorrect : Le poids de votre fichier dépasse la limite autorisée de 3Mo. Merci de réduire son poids et recommencer.\",\n                                            \"mimeTypes\": [\n                                                \"image/png\",\n                                                \"image/jpeg\",\n                                                \"image/gif\",\n                                                \"image/tiff\",\n                                                \"application/pdf\"\n                                            ],\n                                            \"mimeTypesMessage\": \"Format non reconnu : Le format de votre fichier est incorrect. Merci de bien vérifier la liste des formats acceptés.\"\n                                        }\n                                    }\n                                ]\n                            },\n                            \"html\": {\n                                \"extra_form_type\": \"html\",\n                                \"options\": {\n                                    \"content\": \"<p class='confirm-format'>Formats acceptés : jpeg, png, gif, pdf, tiff <br> Poids maximum : 3Mo</p>\",\n                                    \"attr\": {\n                                        \"class\": \"formats center\"\n                                    }\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        },\n        \"identity\": {\n            \"type\": \"form\",\n            \"options\": {\n                \"title\": \"Renseignez vos coordonnées\",\n                \"previous_options\": {\"label\": \"Précédent\"},\n                \"description\": \"RENSEIGNEZ VOS COORDONNEES\",\n                \"attr\": {\n                    \"class\": \"identity\"\n                },\n                \"js\": \"$('form.identity').on('submit', function(){ $('body').addClass('loading'); });$('ul.errors + input').one('focus', function(){$(this).prev().remove();});\",\n                \"display_title\": false,\n                \"@builder\": {\n                    \"worker\": \"extra_form_builder\",\n                    \"parameters\": {\n                        \"configuration\": {\n                            \"spacer\": {\n                                \"extra_form_type\": \"html\",\n                                \"options\": {\n                                    \"content\": \"\",\n                                    \"attr\": {\n                                        \"class\": \"split_line half_column\"\n                                    }\n                                }\n                            },\n                            \"identity_title\": {\n                                \"extra_form_type\": \"html\",\n                                \"options\": {\n                                    \"content\": \"<h3>Vos coordonnées</h3>\"\n                                }\n                            },\n                            \"identity_gender\": {\n                                \"extra_form_type\": \"choice\",\n                                \"options\": {\n                                    \"label\": \"Civilité\",\n                                    \"choices\": {\n                                        \"M.\": \"M.\",\n                                        \"Mme\": \"Mme\"\n                                    },\n                                    \"empty_value\": \"\"\n                                },\n                                \"constraints\": [\n                                    {\n                                        \"extra_form_constraint\": \"not_blank\",\n                                        \"options\": {\n                                            \"message\": \"veuillez selectionner la civilité\"\n                                        }\n                                    }\n                                ]\n                            },\n                            \"identity_lastName\": {\n                                \"extra_form_type\": \"text\",\n                                \"options\": {\n                                    \"label\": \"Nom\",\n                                    \"max_length\" : 25,\n                                    \"pattern\": \"^[A-Za-z-àâäééèêëiîïoôöuùûüç ]{1,25}$\"\n                                },\n                                \"constraints\": [\n                                    {\n                                        \"extra_form_constraint\": \"not_blank\",\n                                        \"options\": {\n                                            \"message\": \"saisie du nom obligatoire\"\n                                        }\n                                    },\n                                    {\n                                        \"extra_form_constraint\": \"regex\",\n                                        \"options\": {\n                                            \"pattern\": \"#^[A-Za-z-àâäééèêëiîïoôöuùûüç ]{1,25}$#\",\n                                            \"match\": true,\n                                            \"message\": \"Merci de renseigner correctement votre nom.\"\n                                        }\n                                    }\n                                ]\n                            },\n                            \"identity_firstName\": {\n                                \"extra_form_type\": \"text\",\n                                \"options\": {\n                                    \"label\": \"Prénom\",\n                                    \"max_length\" : 20,\n                                    \"pattern\": \"^[A-Za-z-àâäééèêëiîïoôöuùûüç ]{1,20}$\"\n                                },\n                                \"constraints\": [\n                                    {\n                                        \"extra_form_constraint\": \"not_blank\",\n                                        \"options\": {\n                                            \"message\": \"saisie du prénom obligatoire\"\n                                        }\n                                    },\n                                    {\n                                        \"extra_form_constraint\": \"regex\",\n                                        \"options\": {\n                                            \"pattern\": \"#^[A-Za-z-àâäééèêëiîïoôöuùûüç ]{1,20}$#\",\n                                            \"match\": true,\n                                            \"message\": \"Merci de renseigner correctement votre prénom.\"\n                                        }\n                                    }\n                                ]\n                            },\n                            \"identity_birthdate\": {\n                                \"extra_form_type\": \"tms_birthday\",\n                                \"options\": {\n                                    \"label\": \"Date de naissance\",\n                                    \"required\": 1,\n                                    \"disabled\": \"0\",\n                                    \"read_only\": \"0\",\n                                    \"empty_value\": \"\",\n                                    \"format\": \"dd MM yyyy\",\n                                    \"start_on\": \"1920\",\n                                    \"widget\": \"choice\",\n                                    \"input\": \"string\",\n                                    \"mapped\": 1,\n                                    \"attr\": {\n                                        \"class\": \"birthdate\"\n                                    }\n                                },\n                                \"constraints\": [\n                                    {\n                                        \"extra_form_constraint\": \"not_blank\",\n                                        \"options\": {\n                                            \"message\": \"Merci de renseigner votre date de naissance\"\n                                        }\n                                    },\n                                    {\n                                        \"extra_form_constraint\": \"tms_age\",\n                                        \"options\": {\n                                            \"format\": \"Y-m-d\",\n                                            \"min\": 18,\n                                            \"minMessage\": \"Cette offre est réservée aux personnes majeures. Vous ne pouvez pas y participer.\"\n                                        }\n                                    }\n                                ]\n                            },\n                            \"identity_email\": {\n                                \"extra_form_type\": \"repeated\",\n                                \"options\": {\n                                    \"type\": \"email\",\n                                    \"invalid_message\": \"Les adresses email doivent correspondre\",\n                                    \"pattern\": \"^[A-Za-z0-9]{1,}([_|\\\\.|-]{1}[A-Za-z0-9]{1,})*@[A-Za-z0-9]{1,}([\\\\.|-]{1}[A-Za-z0-9]{1,})*[\\\\.]{1}[A-Za-z]{2,}$\",\n                                    \"attr\": {\n                                        \"class\": \"split_line half_column\"\n                                    },\n                                    \"first_options\": {\n                                        \"label\": \"E-mail\"\n                                    },\n                                    \"second_options\": {\n                                        \"label\": \"Confirmation E-mail\"\n                                    }\n                                },\n                                \"constraints\": [\n                                    {\n                                        \"extra_form_constraint\": \"not_blank\",\n                                        \"options\": {\n                                            \"message\": \"Merci de renseigner votre adresse email\"\n                                        }\n                                    },\n                                    {\n                                        \"extra_form_constraint\": \"regex\",\n                                        \"options\": {\n                                            \"pattern\": \"#^[A-Za-z0-9]{1,}([_|\\\\.|-]{1}[A-Za-z0-9]{1,})*@[A-Za-z0-9]{1,}([\\\\.|-]{1}[A-Za-z0-9]{1,})*[\\\\.]{1}[A-Za-z]{2,}$#\",\n                                            \"match\": true,\n                                            \"message\": \"Merci de renseigner correctement votre adresse email.\"\n                                        }\n                                    }\n                                ]\n                            },\n                            \"shipping_title\": {\n                                \"extra_form_type\": \"html\",\n                                \"options\": {\n                                    \"content\": \"<h3>Votre adresse de livraison</h3>\"\n                                }\n                            },\n                            \"identity_address1\": {\n                                \"extra_form_type\": \"text\",\n                                \"options\": {\n                                    \"label\": \"Adresse\",\n                                    \"max_length\" : 38\n                                },\n                                \"constraints\": [\n                                    {\n                                        \"extra_form_constraint\": \"not_blank\",\n                                        \"options\": {\n                                            \"message\": \"Merci de renseigner votre adresse\"\n                                        }\n                                    }\n                                ]\n                            },\n                            \"identity_address2\": {\n                                \"extra_form_type\": \"text\",\n                                \"options\": {\n                                    \"label\": \"Complément d'adresse\",\n                                    \"required\": false,\n                                    \"max_length\" : 38\n                                }\n                            },\n                            \"identity_zipCode\": {\n                                \"extra_form_type\": \"text\",\n                                \"options\": {\n                                    \"label\": \"Code postal\"\n                                },\n                                \"constraints\": [\n                                    {\n                                        \"extra_form_constraint\": \"regex\",\n                                        \"options\": {\n                                            \"pattern\": \"#^[0-9]{5}$#\",\n                                            \"match\": true,\n                                            \"message\": \"Merci de renseigner un code postal valide\"\n                                        }\n                                    },\n                                    {\n                                        \"extra_form_constraint\": \"not_blank\",\n                                        \"options\": {\n                                            \"message\": \"Merci de renseigner votre code postal\"\n                                        }\n                                    }\n                                ]\n                            },\n                            \"identity_city\": {\n                                \"extra_form_type\": \"text\",\n                                \"options\": {\n                                    \"label\": \"Ville\"\n                                },\n                                \"constraints\": [\n                                    {\n                                        \"extra_form_constraint\": \"regex\",\n                                        \"options\": {\n                                            \"pattern\": \"#^[A-Za-z-àâäééèêëiîïoôöuùûüç' ]{1,33}$#\",\n                                            \"match\": true,\n                                            \"message\": \"Merci de renseigner correctement votre ville.\"\n                                        }\n                                    },\n                                    {\n                                        \"extra_form_constraint\": \"not_blank\",\n                                        \"options\": {\n                                            \"message\": \"Merci de renseigner votre ville\"\n                                        }\n                                    }\n                                ]\n                            },\n                            \"identity_cguAccepted\": {\n                                \"extra_form_type\": \"checkbox\",\n                                \"options\": {\n                                    \"label\": \"J'ai lu et j'accepte les termes et conditions de l'offre\"\n                                }\n                            },\n                            \"identity_optinEmailNewsletter\": {\n                                \"extra_form_type\": \"checkbox\",\n                                \"options\": {\n                                    \"required\": false,\n                                    \"label\": \"J'accepte de recevoir des informations exclusives et promotions de la part de Nutella et des marques du groupe Ferrero (Kinder, Tic Tac, Ferrero Rocher...)\",\n                                    \"attr\": {\n                                        \"class\": \"split_line\"\n                                    }\n                                }\n                            },\n                            \"html1\": {\n                                \"extra_form_type\": \"html\",\n                                \"options\": {\n                                    \"attr\": {\n                                        \"class\": \"alert_validate\"\n                                    },\n                                    \"content\": \"<br>Attention : nous vous rappelons que l’adresse de livraison n’est pas modifiable après validation.\"\n                                }\n                            },\n                            \"html2\": {\n                                \"extra_form_type\": \"html\",\n                                \"options\": {\n                                    \"attr\": {\n                                        \"class\": \"content\"\n                                    },\n                                    \"content\": \"Les informations recueillies font l'objet d'un traitement informatique nécessaire à l'exécution de votre commande. Les destinataires des données sont FERRERO ainsi que ses prestataires et fournisseurs intervenant dans le cadre de l'exécution de votre commande. Conformément à la loi informatique et libertés du 6 janvier 1978 modifiée en 2004, vous bénéficiez d'un droit d'accès et de rectification aux informations qui vous concernent, que vous pouvez exercer en vous adressant à <a href='http://ferrero.fr/contact' target='_blank'>http://ferrero.fr/contact</a>. Vous pouvez également, pour des motifs légitimes, vous opposer au traitement des données vous concernant.\"\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    },\n    \"paths\": [\n        {\n            \"type\": \"single\",\n            \"options\": {\n                \"source\": \"editor\",\n                \"destination\": \"preview\",\n                \"next_options\": {\n                    \"label\": \"SUIVANT\",\n                    \"attr\": {\n                        \"class\": \"next\"\n                    }\n                },\n                \"events\": {\n                    \"form.post_bind\": [\n                        {\n                            \"action\": \"transform_image\",\n                            \"name\": \"cropped_image\",\n                            \"parameters\": {\n                                \"image_path\": \"http:{{ '{{ flow_data.data.editor[\\'media_uploaded-1\\'].getPublicUri() }}' }}\",\n                                \"transformations\": [\n                                    {\n                                        \"action\": \"scaleImage\",\n                                        \"arguments\": [\n                                            \"{{ '{{ flow_data.data.editor[\\'media_uploaded-1\\'].getMetadata(\\'cropper_image_data\\').width * 4 }}' }}\",\n                                            \"{{ '{{ flow_data.data.editor[\\'media_uploaded-1\\'].getMetadata(\\'cropper_image_data\\').height * 4 }}' }}\"\n                                        ]\n                                    },\n                                    {\n                                        \"action\": \"rotateImage\",\n                                        \"arguments\": [\n                                            \"#FFF\",\n                                            \"{{ '{{ flow_data.data.editor[\\'media_uploaded-1\\'].getMetadata(\\'cropper_data\\').rotate }}' }}\"\n                                        ]\n                                    },\n                                    {\n                                        \"action\": \"cropImage\",\n                                        \"arguments\": [\n                                            \"{{ '{{ flow_data.data.editor[\\'media_uploaded-1\\'].getMetadata(\\'cropper_crop_box_data\\').width * 4 }}' }}\",\n                                            \"{{ '{{ flow_data.data.editor[\\'media_uploaded-1\\'].getMetadata(\\'cropper_crop_box_data\\').height * 4 }}' }}\",\n                                            \"{{ '{% set left = flow_data.data.editor[\\'media_uploaded-1\\'].getMetadata(\\'cropper_data\\').rotate % 90 == 0 ? 0 : flow_data.data.editor[\\'media_uploaded-1\\'].getMetadata(\\'cropper_image_data\\').left %}{{ (flow_data.data.editor[\\'media_uploaded-1\\'].getMetadata(\\'cropper_data\\').x * flow_data.data.editor[\\'media_uploaded-1\\'].getMetadata(\\'cropper_ratio\\') - left) * 4 }}' }}\",\n                                            \"{{ '{% set top = flow_data.data.editor[\\'media_uploaded-1\\'].getMetadata(\\'cropper_data\\').rotate % 90 == 0 ? 0 : flow_data.data.editor[\\'media_uploaded-1\\'].getMetadata(\\'cropper_image_data\\').top %}{{ (flow_data.data.editor[\\'media_uploaded-1\\'].getMetadata(\\'cropper_data\\').y * flow_data.data.editor[\\'media_uploaded-1\\'].getMetadata(\\'cropper_ratio\\') - top) * 4 }}' }}\"\n                                        ]\n                                    },\n                                    {\n                                        \"action\": \"stripImage\",\n                                        \"arguments\": []\n                                    }\n                                ]\n                            }\n                        },\n                        {\n                            \"action\": \"create_text_image\",\n                            \"name\": \"text_image\",\n                            \"parameters\": {\n                                \"width\": 1072,\n                                \"height\": 986,\n                                \"text\": \"pango:<b><span face=\\\"ITC Avant Garde Gothic Std\\\" size=\\\"128760\\\" rise=\\\"-850000\\\">{{ '{{ flow_data.data.editor.miscellaneous_textField | first | lower }}' }}</span><span face=\\\"ITC Avant Garde Gothic Std\\\" size=\\\"128760\\\" rise=\\\"-850000\\\" foreground=\\\"#DA291C\\\">{{ '{{ flow_data.data.editor.miscellaneous_textField[1:] | lower }}' }}</span></b>\",\n                                \"transformations\": [\n                                    {\n                                        \"action\": \"setGravity\",\n                                        \"arguments\": [\"{{ '{{ imagick_const(\\'GRAVITY_CENTER\\') }}' }}\"]\n                                    }\n                                ]\n                            }\n                        },\n                        {\n                            \"action\": \"transform_image\",\n                            \"name\": \"preview\",\n                            \"parameters\": {\n                                \"image_path\": \"@base64:{{ '{{ flow_data.retrievedData.editor.text_image.base64 }}' }}\",\n                                \"transformations\": [\n                                    {\n                                        \"action\": \"compositeImage\",\n                                        \"arguments\": [\n                                            \"@base64:{{ '{{ flow_data.retrievedData.editor.cropped_image.base64 }}' }}\",\n                                            \"{{ '{{ imagick_const(\\'COMPOSITE_DEFAULT\\') }}' }}\",\n                                            \"{{ '{{ flow_data.data.editor[\\'media_uploaded-1\\'].getMetadata(\\'cropper_canvas_data\\').left > 0 ? flow_data.data.editor[\\'media_uploaded-1\\'].getMetadata(\\'cropper_canvas_data\\').left * 4 : 0 }}' }}\",\n                                            \"{{ '{{ flow_data.data.editor[\\'media_uploaded-1\\'].getMetadata(\\'cropper_canvas_data\\').top > 0 ?  flow_data.data.editor[\\'media_uploaded-1\\'].getMetadata(\\'cropper_canvas_data\\').top * 4 : 0 }}' }}\"\n                                        ]\n                                    }\n                                ]\n                            }\n                        },\n                        {\n                            \"action\": \"transform_image\",\n                            \"name\": \"to_print\",\n                            \"parameters\": {\n                                \"image_path\": \"bundles/themes/ferrero/tmswebportalbundle/images/print/template.jpg\",\n                                \"transformations\": [\n                                    {\n                                        \"action\": \"compositeImage\",\n                                        \"arguments\": [\n                                            \"@base64:{{ '{{ flow_data.retrievedData.editor.preview.base64 }}' }}\",\n                                            \"{{ '{{ imagick_const(\\'COMPOSITE_DEFAULT\\') }}' }}\",\n                                            562,\n                                            242\n                                        ]\n                                    },\n                                    {\n                                        \"action\": \"setColorspace\",\n                                        \"arguments\": [\"{{ '{{ imagick_const(\\'COLORSPACE_CMYK\\') }}' }}\"]\n                                    }\n                                ]\n                            }\n                        },\n                        {\n                            \"action\": \"notify\",\n                            \"parameters\": {\n                                \"type\": \"modal\",\n                                \"logical_expression\": \"{{ '{{ flow_data.data.editor.miscellaneous_textField == \\'\\' }}' }}\",\n                                \"options\": {\n                                    \"message\": \"Vous n'avez pas renseigné de texte. Voulez-vous continuer ?\",\n                                    \"level\": \"warning\",\n                                    \"actions\": [\n                                        {\n                                            \"name\": \"Oui\",\n                                            \"href\": \"#\",\n                                            \"attr\": {\n                                                \"class\": \"button close-reveal-modal\"\n                                            }\n                                        },\n                                        {\n                                            \"name\": \"Non\",\n                                            \"href\": \"#\",\n                                            \"attr\": {\n                                                \"class\": \"button close-reveal-modal\",\n                                                \"onClick\": \"$('#idci_step_navigator__back').trigger('click'); $('body').addClass('loading');return false;\"\n                                            }\n                                        }\n                                    ]\n                                }\n                            }\n                        }\n                    ]\n                }\n            }\n        },\n        {\n            \"type\": \"single\",\n            \"options\": {\n                \"source\": \"preview\",\n                \"destination\": \"proof\",\n                \"next_options\": {\n                    \"label\": \"SUIVANT\",\n                    \"attr\": {\n                        \"class\": \"next outside\"\n                    }\n                }\n            }\n        },\n        {\n            \"type\": \"single\",\n            \"options\": {\n                \"source\": \"proof\",\n                \"destination\": \"identity\",\n                \"next_options\": {\n                    \"label\": \"SUIVANT\",\n                    \"attr\": {\n                        \"class\": \"next outside\"\n                    }\n                }\n            }\n        },\n        {\n            \"type\": \"end\",\n            \"options\": {\n                \"source\": \"identity\",\n                \"next_options\": {\n                    \"label\": \"SUIVANT\",\n                    \"attr\": {\n                        \"class\": \"submit\"\n                    }\n                },\n                \"events\": {\n                    \"form.post_bind\": [\n                        {\n                            \"action\": \"store_media\",\n                            \"name\": \"stored_media_preview\",\n                            \"parameters\": {\n                                \"image_path\": \"@base64:{{ '{{ flow_data.retrievedData.editor.preview.base64 }}' }}\",\n                                \"format\": \"png\",\n                                \"metadata\": {\n                                    \"customer\": \"{{ participation.offer.customer.reference }}\",\n                                    \"offer\": \"{{ participation.offer.reference }}\"\n                                }\n                            }\n                        },\n                        {\n                            \"action\": \"store_media\",\n                            \"name\": \"stored_media_to_print\",\n                            \"parameters\": {\n                                \"image_path\": \"@base64:{{ '{{ flow_data.retrievedData.editor.to_print.base64 }}' }}\",\n                                \"metadata\": {\n                                    \"customer\": \"{{ participation.offer.customer.reference }}\",\n                                    \"offer\": \"{{ participation.offer.reference }}\"\n                                }\n                            }\n                        },\n                        {\n                            \"action\": \"purge_flow_data\",\n                            \"parameters\": {\n                                \"steps\": {\n                                    \"editor\": {\n                                        \"retrieved_data\": []\n                                    }\n                                }\n                            }\n                        },\n                        {\n                            \"action\": \"create_order\",\n                            \"name\": \"created_order\",\n                            \"parameters\": {\n                                \"benefit_id\": \"{{ participation.offer.benefits[0].id }}\"\n                            }\n                        },\n                        {\n                            \"action\": \"create_participation\",\n                            \"name\": \"created_participation\",\n                            \"parameters\": {\n                                \"customer\": \"{{ participation.offer.customer.reference }}\",\n                                \"offer\": \"{{ participation.offer.reference }}\",\n                                \"operation\": \"{{ participation.offer.operation.reference }}\",\n                                \"source\": \"digifid - webConsumerApp - ferrero.odr.fr\",\n                                \"order\": \"{{ '{{ flow_data.retrievedData.identity.created_order.id }}' }}\",\n                                \"raw_benefit\": {\n                                    \"benefits\": [{% for benefit in participation.offer.benefits %}\n                                        {\n                                            \"id\": \"{{ benefit.position }}\",\n                                            \"category\": \"{{ benefit.category }}\",\n                                            \"deliveryMethod\": \"{{ benefit.deliveryMethod }}\",\n                                            \"unit\": \"{{ benefit.unit }}\",\n                                            \"unitScale\": \"{{ benefit.unitScale }}\",\n                                            \"raw\": {{ benefit.options|raw }}\n                                        }{% if not loop.last %},{% endif %}\n                                    {% endfor %}],\n                                    \"history\": [{% for benefit in participation.offer.benefits %}\n                                         {\n                                             \"id\": \"{{ benefit.position }}\",\n                                             \"processingState\": \"N\",\n                                             \"date\": \"{{ '{{ \\'now\\'|date(\\'Y-m-d\\\\\\\\TH:i:sO\\') }}' }}\"\n                                        }{% if not loop.last %},{% endif %}\n                                    {% endfor %}]\n                                }\n                            }\n                        },\n                        {\n                            \"action\": \"confirm_order\",\n                            \"parameters\": {\n                                \"order_id\": \"{{ '{{ flow_data.retrievedData.identity.created_order.id }}' }}\"\n                            }\n                        },\n                        {\n                            \"action\": \"notify\",\n                            \"parameters\": {\n                                \"type\": \"modal\",\n                                \"options\": {\n                                    \"title\": \"CONFIRMATION DE<br />VOTRE PARTICIPATION N° {{ '{{ flow_data.retrievedData.identity.created_order.code }}' }}\",\n                                    \"level\": \"info\",\n                                    \"message\": \"<div class='participation small-centered medium-6 medium-centered large-uncentered columns'>Votre participation a bien été prise en compte<br><br><span>Celle-ci fera l'objet d'une vérification conformément à <br /><a href='/content/charte_moderation_nutella'>la charte de modération</a></span> <br><span>Si les éléments fournis et la personnalisation sont valides, alors vous recevrez votre commande d'ici le {{ date('+56days')|date('d/m/Y') }}</span></div><div class='mug small-centered medium-6 medium-centered large-uncentered columns'><img src=\\\"{{ '{{ flow_data.retrievedData.identity.stored_media_preview.publicUri }}' }}.png\\\"/></div>\"\n                                }\n                            }\n                        },\n                        {\n                            \"action\": \"notify\",\n                            \"parameters\": {\n                                \"type\": \"email\",\n                                \"options\": {\n                                    \"notifierAlias\": \"ferrero\",\n                                    \"to\": \"{{ '{{ flow_data.data.identity.identity_email}}' }}\",\n                                    \"subject\": \"Confirmation de votre participation sur Nutella.com\",\n                                    \"htmlMessage\": \"<head>    <meta http-equiv=\\\"Content-Type\\\" content=\\\"text/html; charset=UTF-8\\\" />    <style type=\\\"text/css\\\">    body {background: #FFFFFF;    margin: 0;    font-family: arial;    color: #FFFFFF;    font-size: 12px;    font-weight: 600;}    p {margin, padding:0;    line-height: 110%;}    img {border: 0;    display: block;}    a {color: #FFFFFF;}    strong {    font-size: 13px;    font-weight: 900;}    .alert {font-size: 9px;    text-align: center;    padding: 10px 0;   color: #cecdcd;}    .corps {padding-top: 0px;    padding-right: 30px;    padding-left: 0px;    padding-bottom: 30px;}    .corps2 {padding-top: 0px;    padding-right: 0px;    padding-left: 0px;    padding-bottom: 30px;}    .cadre {border-width: 2;    border-color: #d90210;    border-style: solid;}    .gros {font-size: 13px;}    </style>    <title>Ferrero Nutella</title>    </head>    <body>    <table class=\\\"cadre\\\" width=\\\"640\\\" cellspacing=\\\"0\\\" cellpadding=\\\"0\\\" align=\\\"center\\\" >    <tr>    <td align=\\\"center\\\" height=\\\"60\\\"><img src=\\\"https://ferrero.odr.fr/bundles/themes/ferrero/tmswebportalbundle/images/notification/nutella-logo.png\\\" alt=\\\"Logo Nutella\\\" title=\\\"Logo Nutella\\\" width=\\\"96\\\" height=\\\"29\\\" /></td>    </tr>    </table>    <table width=\\\"640\\\" border=\\\"0\\\" cellspacing=\\\"0\\\" cellpadding=\\\"0\\\" align=\\\"center\\\" bgcolor=\\\"#d90210\\\">    <tr>    <td height=\\\"120\\\" valign=\\\"bottom\\\"><img src=\\\"https://ferrero.odr.fr/bundles/themes/ferrero/tmswebportalbundle/images/notification/nutella-title.png\\\" alt=\\\"Titre\\\" title=\\\"Titre\\\" width=\\\"640\\\" height=\\\"94\\\" />    </tr>    </table>    <table width=\\\"640\\\" border=\\\"0\\\" cellspacing=\\\"0\\\" cellpadding=\\\"0\\\" align=\\\"center\\\" bgcolor=\\\"#d90210\\\">    <tr>    <td valign=\\\"middle\\\" align=\\\"center\\\" width=\\\"309\\\" class=\\\"corps2\\\"><img src=\\\"https://ferrero.odr.fr/bundles/themes/ferrero/tmswebportalbundle/images/notification/nutella-mug.png\\\" alt=\\\"Mug\\\" title=\\\"Mug\\\" width=\\\"249\\\" height=\\\"227\\\"/>    <td align=\\\"left\\\" class=\\\"corps\\\">    <p>    <span class=\\\"gros\\\">Bonjour</span> <strong>{{ '{{ flow_data.data.identity.identity_firstName }}' }}</strong>,</p>    <p>Nous avons bien pris en compte votre participation n°<strong>{{ '{{ flow_data.retrievedData.identity.created_order.code }}' }}</strong> sur le site <a href=\\\"http://www.nutella.com/fr/fr/mon-mug-nutella\\\" target=\\\"_blank\\\">Mon Mug Nutella</a> et nous vous remercions de votre confiance.</p>    <p>Nous allons maintenant procéder à une vérification de votre demande de personnalisation de mug. Si celle-ci ne correspondait pas aux standards de la marque et règles de contenus appropriés indiqués dans la charte de modération disponible sur le site, nous nous verrions contraints de ne pas l&#146;accepter.</p>    <p>Un email vous sera envoyé très prochainement pour vous confirmer que votre personnalisation du mug a été acceptée.</p>    <p><strong>L&#146;équipe Tessi pour Nutella</strong></p>    </td>    </tr>    </table>    <table width=\\\"640\\\" border=\\\"0\\\" cellspacing=\\\"0\\\" cellpadding=\\\"10\\\" align=\\\"center\\\">    <tr>    <td align=\\\"center\\\">    <small class=\\\"alert\\\">Ce message vous est envoyé automatiquement, merci de ne pas y répondre.<br>    ©2016 Ferrero France. Tous droits réservés</small>    </td>    </tr>    </table>    </body>\"\n                                }\n                            }\n                        },\n                        {\n                            \"action\": \"allow_redo_participation\",\n                            \"parameters\": {\n                                \"participation_id\": \"{{ '{{ flow_data.retrievedData.identity.created_participation.id }}' }}\"\n                            }\n                        }\n                    ]\n                }\n            }\n        }\n    ]\n}";